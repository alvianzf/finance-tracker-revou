FROM node:22-alpine

WORKDIR /app

# Install pnpm globally
RUN npm install -g pnpm

# Copy package files first
COPY package*.json ./

# Install dependencies
RUN pnpm install

# Install Postgres client for debugging
RUN apk add --no-cache postgresql-client bash

# Copy source code
COPY . .

# Generate Prisma client
RUN pnpm prisma generate

# Expose ports
EXPOSE 3000 5432 5555

# Dev command: generate Prisma client, migrate, seed, then start NestJS in watch mode
CMD sh -c "pnpm prisma generate && pnpm prisma migrate dev --name init && pnpm prisma db seed && pnpm run start:dev"
